groups:
  - name: hdfs_info
    rules:
      # Alert for any instance that has a median request latency > 1s.
    - alert: APIHighRequestLatency
      expr: api_http_request_latencies_second{quantile="0.5"} > 1
      for: 10m
      labels:
        severity: info
        service: hdfs
      annotations:
        summary: "High request latency on {{ $labels.instance }}"
        description: "Request latency is greater then 1s. Please consider to check network and other health cluster metrics"

  - name: hdfs_warning
    rules:
    - alert: CapacityRemainingGB
      expr: sum by (service_name,task_name) ({__name__=~".*_FSNamesystem_CapacityRemainingGB"}) < 10
      for: 10m
      labels:
       severity: warning
       service: hdfs
      annotations:
       summary: "Low disk capacity remaining in the cluster (less than 20%). Consider increasing data nodes or migrating data to free up space"
       description: "{{ $labels.instance }} / {{ $labels.service_name }} / {{ $labels.task_name }} has capacity remaining {{ $value }}GB"

    - alert: MissingBlocks
      expr: sum by(service_name,task_name) (rate({__name__=~".*_dfs_FSNamesystem_MissingBlocks"}[10m])) > 0
      labels:
        severity: warning
        service: hdfs
      annotations:
       summary: "Missing blocks on {{ $labels.instance }} for {{ $labels.service_name }} / {{ $labels.task_name }}"
       description: "The number of missing blocks have increased over the last 10 min. Please investigate as this means you could lose your data"

    - alert: UnderReplicatedBlocks
      expr: sum by(service_name,task_name) (rate({__name__=~".*_dfs_FSNamesystem_UnderReplicatedBlocks"}[10m])) > 0
      labels:
        severity: warning
        service: hdfs
      annotations:
       summary: "Under replicated blocks on {{ $labels.instance }} for {{ $labels.service_name }} / {{ $labels.task_name }}"
       description: "UnderReplicatedBlocks value has increased for the last 10 min, please consider to check the cluster state"

    - alert: NumStaleDataNodes
      expr: sum by(service_name,task_name) (rate({__name__=~".*_dfs_FSNamesystem_StaleDataNodes"}[10m])) > 0
      labels:
        severity: warning
        service: hdfs
      annotations:
       summary: "Number of stale DataNodes on {{ $labels.instance }} for {{ $labels.service_name }} / {{ $labels.task_name }}"
       description: "DataNode might not emit a heartbeat for a number of reasons â€” network issues or high load are among the more common causes"

    - alert: MemHeapUsed
      expr: (sum({__name__=~".*_jvm_JvmMetrics_MemHeapMaxM"}) / sum({__name__=~".*_jvm_JvmMetrics_MemHeapUsedM"})) < 0.8
      for: 10m
      labels:
        severity: warning
        service: hdfs
      annotations:
       summary: "Total service memory heap in use for {{ $labels.instance }}"
       description: "Total memory heap usage is greater than 80%. Consider increasing memory of the HDFS cluster"

    - alert: MemUsedPercent
      expr: mem_used_percent > 80
      for: 10m
      labels:
        severity: warning
        service: hdfs
      annotations:
       summary: "Instance memory in use percent for {{ $labels.instance }}"
       description: "Total memory heap usage is greater than 80%. Consider increasing memory of the HDFS cluster"

  - name: hdfs_critical
    rules:

    - alert: NumInactiveSources
      expr: (sum({__name__=~".*metricssystem_MetricsSystem_NumAllSources"}) - sum({__name__=~".*metricssystem_MetricsSystem_NumActiveSources"})) > 0
      for: 5m
      labels:
        severity: critical
        service: hdfs
      annotations:
       summary: "Number of inactive sources for {{ $labels.instance }}"
       description: "NumInactiveSources value has increased for the last 5 min, please consider to check the cluster state"

    - alert: VolumeFailures
      expr: sum by (service_name,task_name) ({__name__=~".*_dfs_datanode_VolumeFailures"}) > 0
      for: 5m
      labels:
        severity: critical
        service: hdfs
      annotations:
       summary: "VolumeFailures on {{ $labels.instance }} for {{ $labels.service_name }} / {{ $labels.task_name }}"
       description: "Hardware failures occur, please consider replace the failed hardware. Failed volume is not a data loss signal"

